import { computed, type ComputedRef } from 'vue'
import type { Completion } from '@codemirror/autocomplete'
import type { IdeaEntry, TagEntry } from '../api/tauri'
import { useIdeaRegistry } from './useIdeaRegistry'
import { useTagRegistry } from './useTagRegistry'

/**
 * GrammarCompletionItem 负责描述补全项的核心元数据
 * 增加来源字段，便于后续排序与调试
 */
export interface GrammarCompletionItem extends Completion {
  /**
   * 来源标签，标识补全项属于何种数据源
   */
  source: 'keyword' | 'idea' | 'tag'
}

/**
 * 静态关键字列表，来自 mission.txt 任务描述
 * 该列表会在初始化时转换为补全项常量
 */
const STATIC_KEYWORDS: string[] = [
  'if',
  'else',
  'limit',
  'set_variable',
  'set_temp_variable',
  'var',
  'value',
  'add_to_variable',
  'subtract_from_variable',
  'multiply_variable',
  'divide_variable',
  'modulo_variable',
  'randomize_variable',
  'clamp_variable',
  'min',
  'max',
  'lambda',
  'distribution',
  'round_variable',
  'clear_variable',
  'Orientation',
  'democratic',
  'fascism',
  'communism',
  'neutrality',
  'conservatism',
  'liberalism',
  'socialism',
  'populism',
  'marxism',
  'leninism',
  'stalinism',
  'anti_revisionism',
  'anarchist_communism',
  'nazism',
  'gen_nazism',
  'fascism_ideology',
  'falangism',
  'rexism',
  'despotism',
  'oligarchism',
  'anarchism',
  'moderatism',
  'centrism',
  'add_tech_bonus',
  'light_air',
  'medium_air',
  'heavy_air',
  'armor',
  'cat_light_armor',
  'cat_medium_armor',
  'cat_heavy_armor',
  'artillery',
  'cat_anti_tank',
  'cat_anti_air',
  'naval_air',
  'infantry_weapons',
  'motorized_equipment',
  'cat_mechanized_equipment',
  'naval_equipment',
  'rocketry',
  'nuclear',
  'industry',
  'electronics',
  'cat_fortification',
  'land_doctrine',
  'air_doctrine',
  'naval_doctrine',
  'strategic_destruction_tree',
  'battlefield_support_tree',
  'operational_integrity_tree',
  'jet_technology',
  'trade_interdiction_tree',
  'convoy_defense_tree',
  'light_fighter',
  'cat_heavy_fighter',
  'tactical_bomber',
  'cat_strategic_bomber',
  'naval_bomber',
  'cas_bomber',
  'ship_modules_tech',
  'dd_tech',
  'cl_tech',
  'ca_tech',
  'cv_tech',
  'bc_tech',
  'bb_tech',
  'shbb_tech',
  'ss_tech',
  'tp_tech',
  'synth_resources',
  'fleet_in_being_tree',
  'encryption_tech',
  'decryption_tech',
  'computing_tech',
  'radar_tech',
  'infantry_tech',
  'marine_tech',
  'construction_tech',
  'excavation_tech',
  'submarine_doctrine',
  'air_equipment',
  'cat_mobile_warfare',
  'cat_superior_firepower',
  'cat_grand_battle_plan',
  'cat_mass_assault',
  'cat_base_strike',
  'cat_trade_interdiction',
  'cat_fleet_in_being',
  'cat_strategic_destruction',
  'cat_battlefield_support',
  'cat_operational_integrity',
  'night_vision',
  'base_strike_main',
  'mot_rockets',
  'support_tech',
  'para_tech',
  'engineers_tech',
  'recon_tech',
  'mountaineers_tech',
  'military_police_tech',
  'hospital_tech',
  'logistics_tech',
  'signal_company_tech',
  'maintenance_company_tech',
  'naval_mines',
  'concentrated_industry_category',
  'dispersed_industry_category',
  'asw_tech',
  'naval_minesweeping',
  'naval_minelaying',
  'cat_scout_plane',
  'train_tech',
  'cat_production',
  'cat_synth_rubber',
  'cat_synth_oil',
  'cat_armored_cars',
  'cat_special_forces_generic',
  'cat_torpedoes',
  'cat_ship_light_battery',
  'cat_ship_medium_battery',
  'cat_ship_heavy_battery',
  'plane_modules_tech',
  'cat_air_guns',
  'cat_air_engine',
  'cat_air_bombs',
  'special_forces_doctrine',
  'cat_maritime_patrol',
  'cat_mountaineers_doctrine',
  'cat_marines_doctrine',
  'cat_paratroopers_doctrine',
  'naval_armor',
  'naval_artillery',
  'helicopter_tech',
  'pykrete_tech',
  'transport_planes_cat',
  'mio_cat_tech_all_armor_and_modules',
  'mio_cat_tech_light_armor_and_modules',
  'mio_cat_tech_medium_armor_and_modules',
  'mio_cat_tech_heavy_armor_and_modules',
  'mio_cat_all_artillery_equipment',
  'mio_cat_all_light_fighter_and_modules',
  'mio_cat_all_cas_and_modules',
  'mio_cat_all_naval_bomber_and_modules',
  'mio_cat_all_light_aircraft_and_modules',
  'mio_cat_all_medium_aircraft_and_modules',
  'mio_cat_all_heavy_aircraft_and_modules',
  'mio_cat_tech_all_capital_ship_and_modules',
  'mio_cat_tech_all_screen_ship_and_modules',
  'mio_cat_tech_all_submarine_and_modules',
  'mio_cat_tech_all_carrier_and_modules',
  'mio_cat_tech_all_cruiser_and_modules',
  'mio_cat_tech_all_destroyer_and_modules',
  'mio_cat_tech_all_motorized_mechanized',
  'mio_cat_artillery',
  'allowed',
  'visible',
  'available',
  'OR',
  'AND',
  'NOT',
  'bypass',
  'custom_trigger_tooltip',
  'id',
  'is_in_faction_with',
  'has_stability',
  'has_war_support',
  'is_ai',
  'original_tag',
  'has_country_leader',
  'has_global_flag',
  'has_country_flag',
  'date',
  'tag',
  'has_government',
  'is_historical_focus_on',
  'is_in_faction',
  'has_war_with',
  'has_war',
  'has_capitulated',
  'NOT_country_exists',
  'country_exists',
  'surrender_progress',
  'owns_state',
  'controls_state',
  'has_full_control_of_state',
  'core_state',
  'threat',
  'compare_autonomy_progress_ratio',
  'has_completed_focus',
  'is_subject',
  'num_of_factories',
  'industrial_complex',
  'arms_factory',
  'dockyard',
  'has_manpower',
  'num_of_civilian_factories_available_for_projects',
  'has_idea',
  'has_tech',
  'is_subject_of',
  'has_army_manpower',
  'has_deployed_air_force_size',
  'has_opinion',
  'focus_progress',
  'controller',
  'capital_scope',
  'shared_focus',
  'initial_show_position',
  'fire_only_once',
  'days_re_enable',
  'days_remove',
  'complete_effect',
  'remove_effect',
  'mutually_exclusive',
  'prerequisite',
  'available_if_capitulated',
  'completion_reward',
  'continuous_focus_position',
  'relative_position_id',
  'modifier',
  'highlight_state_targets',
  'complete_tooltip',
  'set_global_flag',
  'clr_global_flag',
  'set_country_flag',
  'clr_country_flag',
  'set_technology',
  'set_party_name',
  'add_popularity',
  'set_politics',
  'elections_allowed',
  'set_cosmetic_tag',
  'complete_national_focus',
  'add_named_threat',
  'annex_country',
  'set_state_controller',
  'transfer_state',
  'add_state_claim',
  'white_peace',
  'add_stability',
  'add_war_support',
  'add_research_slot',
  'add_political_power',
  'army_experience',
  'navy_experience',
  'air_experience',
  'add_ideas',
  'remove_ideas',
  'add_timed_idea',
  'news_event',
  'country_event',
  'declare_war_on',
  'create_wargoal',
  'puppet_wargoal_focus',
  'annex_everything',
  'take_state_focus',
  'take_state',
  'take_claimed_state',
  'create_faction',
  'create_country_leader',
  'remove_country_leader_trait',
  'set_capital',
  'load_oob',
  'add_command_power',
  'add_state_core',
  'add_core_of',
  'unlock_decision_category_tooltip',
  'unlock_decision_tooltip',
  'show_ideas_tooltip',
  'custom_effect_tooltip',
  'effect_tooltip',
  'remove_unit_leader',
  'build_railway',
  'path',
  'set_autonomy',
  'target',
  'TAG',
  'autonomy_state',
  'autonomy_dominion',
  'autonomy_supervised_state',
  'autonomy_colony',
  'autonomy_puppet',
  'autonomy_integrated_puppet',
  'autonomy_reichskommissariat',
  'autonomy_reichsprotectorate',
  'autonomy_satellite',
  'autonomy_wtt_imperial_associate',
  'autonomy_wtt_imperial_protectorate',
  'autonomy_wtt_imperial_subject',
  'autonomy_collaboration_government',
  'autonomy_personal_union',
  'autonomy_communist_satellite',
  'autonomy_occupation_zone',
  'autonomy_aat_defense_council_member',
  'autonomy_austro_hungarian_subject',
  'autonomy_volkskommissariat',
  'autonomy_eu_member',
  'set_rule',
  'can_create_factions',
  'can_send_volunteers',
  'can_declare_war_on_same_ideology',
  'can_only_justify_war_on_threat_country',
  'every_army_leader',
  'add_attack',
  'add_defense',
  'add_planning',
  'add_logistics',
  'add_skill_level',
  'add_unit_leader_trait',
  'every_unit_leader',
  'set_nationality',
  'add_to_faction',
  'take_core_state',
  'civil_war',
  'topple_government',
  'liberate_wargoal',
  'independence_wargoal',
  'hidden_effect',
  'random_list',
  'swap_ideas',
  'remove_idea',
  'add_idea',
  'autonomy_free',
  'add_autonomy_ratio',
  'localization',
  'popularity',
  'ruling_party',
  'last_election',
  'election_frequency',
  'else_if',
  'add_equipment_to_stockpile',
  'producer',
  'add_extra_state_shared_building_slots',
  'add_building_construction',
  'instant_build',
  'random_state',
  'every_state',
  'random_owned_controlled_state',
  'is_controlled_by',
  'is_core_of',
  'add_offsite_building',
  'infrastructure',
  'air_base',
  'type',
  'level',
  'province',
  'province.id',
  'all_provinces',
  'limit_to_coastal',
  'limit_to_naval_base',
  'limit_to_border',
  'limit_to_border_country',
  'limit_to_victory_point',
  'limit_to_supply_node',
  'supply_node',
  'naval_base',
  'bunker',
  'coastal_bunker',
  'dam',
  'add_resource',
  'amount',
  'resources',
  'steel',
  'oil',
  'tungsten',
  'chromium',
  'aluminium',
  'rubber',
  'megalopolis',
  'metropolis',
  'large_city',
  'city',
  'large_town',
  'town',
  'rural',
  'small_island',
  'pastoral',
  'wasteland',
  'enclave',
  'tiny_island',
  'civilian_factory_use',
  'send_volunteer_divisions_required',
  'generate_wargoal_tension',
  'justify_war_goal_time',
  'join_faction_tension',
  'surrender_limit',
  'opinion_gain_monthly_factor',
  'improve_relations_maintain_cost_factor',
  'opinion_gain_monthly_same_ideology',
  'opinion_gain_monthly_same_ideology_factor',
  'consumer_goods_factor',
  'consumer_goods_expected_value',
  'min_export',
  'trade_opinion_factor',
  'mobilization_laws_cost_factor',
  'trade_laws_cost_factor',
  'economy_cost_factor',
  'political_advisor_cost_factor',
  'tank_manufacturer_cost_factor',
  'naval_manufacturer_cost_factor',
  'aircraft_manufacturer_cost_factor',
  'materiel_manufacturer_cost_factor',
  'industrial_concern_cost_factor',
  'theorist_cost_factor',
  'army_chief_cost_factor',
  'navy_chief_cost_factor',
  'air_chief_cost_factor',
  'high_command_cost_factor',
  'research_speed_factor',
  'state_resource_<Resource>',
  'state_resource_cost_<Resource>',
  'state_resources_<Resource>_factor',
  'state_resources_factor',
  'temporary_state_resource_<Resource>',
  'production_lack_of_resource_penalty_factor',
  'local_resources_factor',
  'local_resources',
  'country_resource_<Resource>',
  'country_resource_cost_<Resource>',
  'resource_trade_cost_bonus_per_factory',
  'autonomy_gain',
  'local_building_slots_factor',
  'global_building_slots_factor',
  'local_building_slots',
  'global_building_slots',
  'production_speed_buildings_factor',
  'production_speed_nuclear_reactor_factor',
  'production_speed_arms_factory_factor',
  'production_speed_industrial_complex_factor',
  'production_speed_infrastructure_factor',
  'production_speed_synthetic_refinery_factor',
  'production_speed_dockyard_factor',
  'production_speed_bunker_factor',
  'conversion_cost_civ_to_mil_factor',
  'subversive_activites_upkeep',
  'drift_defence_factor',
  'political_power_factor',
  'political_power_gain',
  'political_power_cost',
  'stability_factor',
  'stability_weekly',
  'stability_weekly_factor',
  'defensive_war_stability_factor',
  'offensive_war_stability_factor',
  'war_support_factor',
  'war_support_weekly',
  'command_power_gain',
  'max_command_power',
  'command_power_gain_mult',
  'max_command_power_mult',
  'training_time_army_factor',
  'resistance_target',
  'resistance_target_on_our_occupied_states',
  'resistance_decay',
  'resistance_decay_on_our_occupied_states',
  'resistance_growth',
  'resistance_growth_on_our_occupied_states',
  'compliance_starting_value',
  'compliance_gain',
  'compliance_growth',
  'compliance_growth_on_our_occupied_states',
  'required_garrison_factor',
  'attrition',
  'army_org_factor',
  'army_morale_factor',
  'supply_consumption_factor',
  'no_supply_grace',
  'org_loss_when_moving',
  'breakthrough_factor',
  'recon_factor',
  'land_reinforce_rate',
  'military_leader_cost_factor',
  'army_leader_start_level',
  'acclimatization_hot_climate_gain_factor',
  'acclimatization_cold_climate_gain_factor',
  'conscription',
  'conscription_factor',
  'non_core_manpower',
  'monthly_population',
  'weekly_manpower',
  'mobilization_speed',
  'line_change_production_efficiency_factor',
  'production_factory_efficiency_gain_factor',
  'production_factory_max_efficiency_factor',
  'production_factory_start_efficiency_factor',
  'industrial_capacity_factory',
  'industrial_capacity_dockyard',
  'refit_ic_cost',
  'refit_speed',
  'repair_speed_factor',
  'army_infantry_attack_factor',
  'army_infantry_defence_factor',
  'motorized_attack_factor',
  'motorized_defence_factor',
  'mechanized_attack_factor',
  'mechanized_defence_factor',
  'army_artillery_attack_factor',
  'army_artillery_defence_factor',
  'army_armor_attack_factor',
  'army_armor_defence_factor',
  'army_core_attack_factor',
  'army_core_defence_factor',
  'army_attack_factor',
  'army_defence_factor',
  'army_speed_factor',
  'army_bonus_air_superiority_factor',
  'planning_speed',
  'max_planning',
  'max_planning_factor',
  'max_dig_in_factor',
  'max_dig_in',
  'experience_loss_factor',
  'experience_gain_army_factor',
  'navy_org',
  'navy_screen_attack_factor',
  'navy_screen_defence_factor',
  'navy_capital_ship_attack_factor',
  'naval_speed_factor',
  'navy_max_range_factor',
  'navy_carrier_air_attack_factor',
  'navy_carrier_air_targetting_factor',
  'SORTIE_EFFICIENCY_FACTOR',
  'screening_efficiency',
  'naval_retreat_speed',
  'positioning',
  'spotting_chance',
  'navy_fuel_consumption_factor',
  'army_fuel_consumption_factor',
  'air_fuel_consumption_factor',
  'navy_anti_air_attack_factor',
  'air_cas_present_factor',
  'air_accidents',
  'air_weather_penalty',
  'air_attack_factor',
  'air_ace_generation_chance_factor',
  'air_mission_efficiency',
  'air_superiority_efficiency',
  'air_intercept_efficiency',
  'air_cas_efficiency',
  'air_night_penalty',
  'air_range_factor',
  'air_agility_factor',
  'air_escort_efficiency',
  'strategic_bomber_bombing_factor',
  'invasion_preparation',
  'NAVAL_INVASION_PENALTY',
  'amphibious_invasion',
  'ai_focus_aggressive_factor',
  'ai_focus_defense_factor',
  'ai_call_ally_desire_factor',
  'ai_join_ally_desire_factor',
  'ai_get_ally_desire_factor',
  'ai_focus_naval_factor',
  'ai_focus_naval_air_factor',
  'ai_focus_aviation_factor',
  'rule',
  'has_navy_size',
  'equipment_bonus',
  'amphibious_mechanized_equipment',
  'amphibious_mechanized_equipment_1',
  'amphibious_mechanized_equipment_2',
  'anti_air_equipment',
  'anti_air_equipment_1',
  'anti_air_equipment_2',
  'anti_air_equipment_3',
  'anti_tank_equipment',
  'anti_tank_equipment_1',
  'anti_tank_equipment_2',
  'anti_tank_equipment_3',
  'armored_car_equipment',
  'gw_armored_car_equipment',
  'armored_car_equipment_1',
  'armored_car_equipment_2',
  'armored_car_at_equipment',
  'artillery_equipment',
  'artillery_equipment_1',
  'artillery_equipment_2',
  'artillery_equipment_3',
  'rocket_artillery_equipment',
  'rocket_artillery_equipment_1',
  'rocket_artillery_equipment_2',
  'motorized_rocket_equipment',
  'motorized_rocket_equipment_1',
  'convoy',
  'convoy_1',
  'floating_harbor_equipment',
  'floating_harbor_equipment_1',
  'guided_missile_equipment',
  'guided_missile_equipment_1',
  'guided_missile_equipment_2',
  'guided_missile_equipment_3',
  'infantry_equipment',
  'infantry_equipment_0',
  'infantry_equipment_1',
  'infantry_equipment_2',
  'infantry_equipment_3',
  'mechanized_equipment',
  'mechanized_equipment_1',
  'mechanized_equipment_2',
  'mechanized_equipment_3',
  'motorized_equipment',
  'motorized_equipment_0',
  'motorized_equipment_1',
  'small_plane_airframe',
  'small_plane_airframe_0',
  'small_plane_airframe_1',
  'small_plane_airframe_2',
  'small_plane_airframe_3',
  'small_plane_airframe_4',
  'cv_small_plane_airframe',
  'cv_small_plane_airframe_0',
  'cv_small_plane_airframe_1',
  'cv_small_plane_airframe_2',
  'cv_small_plane_airframe_3',
  'cv_small_plane_airframe_4',
  'small_plane_cas_airframe',
  'cv_small_plane_cas_airframe',
  'small_plane_naval_bomber_airframe',
  'cv_small_plane_naval_bomber_airframe',
  'small_plane_suicide_airframe',
  'cv_small_plane_suicide_airframe',
  'jet_fighter_equipment',
  'rocket_interceptor_equipment',
  'medium_plane_airframe',
  'medium_plane_airframe_0',
  'medium_plane_airframe_1',
  'medium_plane_airframe_2',
  'medium_plane_airframe_3',
  'medium_plane_airframe_4',
  'medium_plane_fighter_airframe',
  'medium_plane_scout_plane_airframe',
  'jet_tac_bomber_equipment',
  'large_plane_airframe',
  'large_plane_airframe_0',
  'large_plane_airframe_1',
  'large_plane_airframe_2',
  'large_plane_airframe_3',
  'large_plane_airframe_4',
  'large_plane_maritime_patrol_plane_airframe',
  'jet_strat_bomber_equipment',
  'transport_plane_equipment',
  'transport_plane_equipment_1',
  'transport_plane_equipment_2',
  'transport_plane_equipment_3',
  'railway_gun_equipment',
  'railway_gun_equipment_1',
  'ship_hull_carrier',
  'ship_hull_carrier_1',
  'ship_hull_carrier_2',
  'ship_hull_carrier_3',
  'ship_hull_carrier_conversion_bb',
  'ship_hull_carrier_conversion_ca',
  'ship_hull_cruiser',
  'ship_hull_cruiser_1',
  'ship_hull_cruiser_2',
  'ship_hull_cruiser_3',
  'ship_hull_cruiser_4',
  'light_cruiser_1',
  'light_cruiser_2',
  'light_cruiser_3',
  'light_cruiser_4',
  'heavy_cruiser_1',
  'heavy_cruiser_2',
  'heavy_cruiser_3',
  'heavy_cruiser_4',
  'torpedo_cruiser',
  'ship_hull_torpedo_cruiser',
  'ship_hull_cruiser_panzerschiff',
  'ship_hull_cruiser_coastal_defense_ship',
  'ship_hull_heavy',
  'ship_hull_heavy_1',
  'ship_hull_heavy_2',
  'ship_hull_heavy_3',
  'ship_hull_heavy_4',
  'ship_hull_pre_dreadnought',
  'ship_hull_super_heavy_1',
  'battleship_1',
  'battleship_2',
  'battleship_3',
  'battleship_4',
  'SH_battleship_1',
  'SH_battleship_2',
  'battle_cruiser_1',
  'battle_cruiser_2',
  'battle_cruiser_3',
  'battle_cruiser_4',
  'ship_hull_light',
  'ship_hull_light_1',
  'ship_hull_light_2',
  'ship_hull_light_3',
  'ship_hull_light_4',
  'destroyer_1',
  'destroyer_2',
  'destroyer_3',
  'destroyer_4',
  'ship_hull_submarine',
  'ship_hull_submarine_1',
  'ship_hull_submarine_2',
  'ship_hull_submarine_3',
  'ship_hull_submarine_4',
  'ship_hull_cruiser_submarine',
  'ship_hull_midget_submarine',
  'submarine_1',
  'submarine_2',
  'submarine_3',
  'submarine_4',
  'support_equipment',
  'support_equipment_1',
  'light_tank_chassis',
  'light_tank_chassis_0',
  'light_tank_chassis_1',
  'light_tank_chassis_2',
  'light_tank_chassis_3',
  'light_tank_aa_chassis',
  'light_tank_artillery_chassis',
  'light_tank_destroyer_chassis',
  'light_tank_amphibious_chassis',
  'light_tank_flame_chassis',
  'medium_tank_chassis',
  'medium_tank_chassis_0',
  'medium_tank_chassis_1',
  'medium_tank_chassis_2',
  'medium_tank_chassis_3',
  'medium_tank_aa_chassis',
  'medium_tank_artillery_chassis',
  'medium_tank_destroyer_chassis',
  'medium_tank_amphibious_chassis',
  'medium_tank_flame_chassis',
  'heavy_tank_chassis',
  'heavy_tank_chassis_0',
  'heavy_tank_chassis_1',
  'heavy_tank_chassis_2',
  'heavy_tank_chassis_3',
  'heavy_tank_aa_chassis',
  'heavy_tank_artillery_chassis',
  'heavy_tank_destroyer_chassis',
  'heavy_tank_amphibious_chassis',
  'heavy_tank_flame_chassis',
  'super_heavy_tank_chassis',
  'super_heavy_tank_chassis_1',
  'super_heavy_tank_aa_chassis',
  'super_heavy_tank_artillery_chassis',
  'super_heavy_tank_destroyer_chassis',
  'modern_tank_chassis',
  'modern_tank_chassis_1',
  'modern_tank_aa_chassis',
  'modern_tank_artillery_chassis',
  'modern_tank_destroyer_chassis',
  'amphibious_tank_chassis',
  'amphibious_tank_chassis_1',
  'train_equipment',
  'train_equipment_1',
  'train_equipment_2',
  'train_equipment_3',
  'lend_lease_cost',
  'build_cost_ic',
  'manpower',
  'can_license',
  'is_convertable',
  'instant',
  'reliability',
  'maximum_speed',
  'soft_attack',
  'hard_attack',
  'air_attack',
  'ap_attack',
  'breakthrough',
  'defense',
  'max_strength',
  'armor_value',
  'hardness',
  'entrenchment',
  'recon',
  'naval_speed',
  'lg_armor_piercing',
  'lg_attack',
  'hg_armor_piercing',
  'hg_attack',
  'torpedo_attack',
  'anti_air_attack',
  'shore_bombardment',
  'surface_detection',
  'sub_attack',
  'sub_detection',
  'surface_visibility',
  'sub_visibility',
  'naval_range',
  'port_capacity_usage',
  'search_and_destroy_coordination',
  'convoy_raiding_coordination',
  'air_defence',
  'air_range',
  'air_agility',
  'air_ground_attack',
  'air_bombing',
  'air_superiority',
  'naval_strike_attack',
  'naval_strike_targetting',
  'carrier_size',
  'default_carrier_composition_weight',
  'carrier_capable',
  'targeted_modifier',
  'tag',
  'extra_trade_to_target_factor',
  'generate_wargoal_tension_against',
  'cic_to_target_factor',
  'mic_to_target_factor',
  'trade_cost_for_target_factor',
  'targeted_legitimacy_daily',
  'attack_bonus_against',
  'attack_bonus_against_cores',
  'breakthrough_bonus_against',
  'defense_bonus_against',
  'ai_will_do',
  'factor',
  'modifier',
  'has_war',
  'fire_only_once',
  'is_triggered_only',
  'hidden',
  'ROOT',
  'FROM',
  'immediate',
  'trigger',
  'ai_chance',
  'capital_scope',
  'create_unit',
  'division',
  'owner',
  'division_template',
  'name',
  'priority',
  'regiments',
  'motorized',
  'x',
  'y',
  'support',
  'mot_recon',
  'infantry',
  'cavalry',
  'artillery_brigade',
  'light_armor',
  'medium_armor',
  'heavy_armor',
  'modern_armor',
  'camelry',
  'super_heavy_armor',
  'marine',
  'paratrooper',
  'amphibious_armor',
  'amphibious_mechanized',
  'anti_tank_brigade',
  'anti_air_brigade',
  'armored_car',
  'mot_artillery_brigade',
  'rocket_artillery_brigade',
  'mot_rocket_artillery_brigade',
  'motorized_rocket_brigade',
  'bicycle_batallion',
  'mountaineers',
  'mechanized',
  'light_sp_anti_air_brigade',
  'medium_sp_anti_air_brigade',
  'heavy_sp_anti_air_brigade',
  'super_heavy_sp_anti_air_brigade',
  'modern_sp_anti_air_brigade',
  'light_sp_artillery_brigade',
  'medium_sp_artillery_brigade',
  'heavy_sp_artillery_brigade',
  'super_heavy_sp_artillery_brigade',
  'modern_sp_artillery_brigade',
  'light_tank_destroyer_brigade',
  'medium_tank_destroyer_brigade',
  'heavy_tank_destroyer_brigade',
  'super_heavy_tank_destroyer_brigade',
  'modern_tank_destroyer_brigade',
  'shipgirl_brigade',
  'engineer',
  'artillery',
  'military_police',
  'armored_car_recon',
  'light_tank_recon',
  'anti_air',
  'anti_tank',
  'field_hospital',
  'logistics_company',
  'maintenance_company',
  'rocket_artillery',
  'signal_company',
  'fight_shipgirl',
  'command_shipgirl',
]

/**
 * 静态补全项常量，避免重复创建对象
 */
const STATIC_COMPLETIONS: GrammarCompletionItem[] = STATIC_KEYWORDS.map((keyword) => ({
  label: keyword,
  type: 'keyword',
  detail: '',
  boost: 50,
  source: 'keyword'
}))

/**
 * 创建 Idea 补全项
 * @param ideas 当前加载的 Idea 列表
 */
function createIdeaCompletions(ideas: IdeaEntry[]): GrammarCompletionItem[] {
  return ideas.map((idea) => ({
    label: idea.id,
    type: 'variable',
    detail: `[Idea -> (${idea.source === 'game' ? '游戏内置' : '项目自定义'})]`,
    boost: 30,
    source: 'idea'
  }))
}

/**
 * 创建 Tag 补全项
 * @param tags 当前加载的国家标签列表
 */
function createTagCompletions(tags: TagEntry[]): GrammarCompletionItem[] {
  return tags.map((tag) => ({
    label: tag.code,
    type: 'variable',
    detail: `[Tag -> (${tag.source === 'game' ? '游戏内置' : '项目自定义'})]`,
    boost: 30,
    source: 'tag'
  }))
}

/**
 * 合并并排序补全项，遵循字母序与来源优先级
 * 来源优先级: keyword > tag > idea
 */
function mergeCompletions(
  keywordItems: GrammarCompletionItem[],
  ideaItems: GrammarCompletionItem[],
  tagItems: GrammarCompletionItem[]
): GrammarCompletionItem[] {
  const priorityMap: Record<GrammarCompletionItem['source'], number> = {
    keyword: 0,
    tag: 1,
    idea: 2
  }

  const merged = new Map<string, GrammarCompletionItem>()

  const insertItems = (items: GrammarCompletionItem[]) => {
    items.forEach((item) => {
      const key = item.label.toUpperCase()
      if (!merged.has(key)) {
        merged.set(key, item)
      }
    })
  }

  insertItems(keywordItems)
  insertItems(tagItems)
  insertItems(ideaItems)

  const sorted = Array.from(merged.values()).sort((a, b) => {
    const labelCompare = a.label.localeCompare(b.label, 'en', { sensitivity: 'base' })
    if (labelCompare !== 0) {
      return labelCompare
    }
    return priorityMap[a.source] - priorityMap[b.source]
  })

  return sorted
}

/**
 * 提供 GrammarCompletion 数据组合的组合式函数
 * 返回静态补全、Idea 补全、Tag 补全以及合并后的结果
 */
export function useGrammarCompletion(): {
  staticItems: ComputedRef<GrammarCompletionItem[]>
  ideaItems: ComputedRef<GrammarCompletionItem[]>
  tagItems: ComputedRef<GrammarCompletionItem[]>
  allItems: ComputedRef<GrammarCompletionItem[]>
} {
  const { ideas } = useIdeaRegistry()
  const { tags } = useTagRegistry()

  const staticItems = computed(() => STATIC_COMPLETIONS)

  const ideaItems = computed(() => {
    const sourceIdeas = ideas.value ?? []
    return createIdeaCompletions(sourceIdeas)
  })

  const tagItems = computed(() => {
    const sourceTags = tags.value ?? []
    return createTagCompletions(sourceTags)
  })

  const allItems = computed(() =>
    mergeCompletions(staticItems.value, ideaItems.value, tagItems.value)
  )

  return {
    staticItems,
    ideaItems,
    tagItems,
    allItems
  }
}
